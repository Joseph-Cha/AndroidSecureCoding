# 01. 안드로이드 이해

## 1.1 안드로이드 시대별 버전

- 아직 보안 쪽에서는 안드로이드 4버전까지 포함을 하고 있다.
    - 갤럭시 노트 2를 아직까지 사용 중인 유저가 있음
- 예전 버전과 현재 버전에 따라 보안에서 고려해야 할 부분이 다르다.

## 1.2 안드로이드 운영체제 소개

- 구글에서 개발한 리눅스 기반 오픈소스 플랫폼(리눅스 커널 기반)

## 1.3 안드로이드 운영체제 구조

![image](/Resources/ch.01/1.png)

취약점 분석 시 많은 고려 x(하드웨어 적인 부분)

- 리눅스 커널
- HAL(Hardware Abstraction Layer)

취약점 분석 대상

- Android Rumtime
    - 중요
    - apk 파일이 설치가 될 때 안드로이드 런타임에 의해서 앱이 동작
    - ART
- 네이티브 C/C++ 라이브러리
    - .so 파일로 컴파일되어 앱과 연결되어 사용
    - c/c++ 분석과 동일
    - 보안 솔루션이 되부분 c++로 되어 있음 → c++로 되어 있는 보안 라이브러리를 시스템 앱단에서 사용해서 앱을 보안
- Java API 프레임워크
    - JVM에서 동작
    - Managers → 앱에서 사용하는 다양한 기능들을 관리(Notification, Activity 등)
- 시스템 앱
    - 사용자가 작성한 java 코드 영역

## 1.4 앱 컴포넌트 (구성 요소)

- 앱 컴포넌트는 안드로이드 앱의 필수적인 구성 요소로 각 독립된 형태로 존재하며 정해진 역할을 수행
- 각 구성 요소는 시스템이나 사용자가 앱에 들어올 수 있는 진입점
- “인텐트”는 다른 앱 컴포넌트로 작업을 요청하는 데 사용할 수 있는 메시징 객체
- 즉, 다른 앱 컴포넌트에 메시지를 전달해 주는 역할을 인텐트가 담당한다.
- 취약점 분석시 인텐트를 분석하지는 않고 각 컴포넌트를 분석을 한다.

![Untitled](/Resources/ch.01/2.png)

## 1.5 안드로이드 4대 컴포넌트 (구성 요소)

### 1.5.1 액티비티

- 사용자와 상호작용하기 위한 진입점
- 사용자가 보는 화면들
- 사용자 인터페이스를 포함한 하나의 화면
- 액티비티를 통해 특정 동작을 하게 되면 해당 동작에 맞게 각 컴포넌트들이 동작을 하는 시스템
- 이메일 앱이라면 새 이메일 목록을 표시하는 액티비티 하나, 이메일을 작성하는 액티비티 하나, 이메일을 읽는데 쓰는 액티비티 하나 등이 존재
- 이메일 앱에서 허용할 경우 다른 앱에서 이와 같은 액티비티 중 하나를 시작할 수 있음

### 1.5.2 서비스

- 백그라운드에서 앱을 계속 실행하기 위한 다목적 진입점
- UI는 제공하지 않음
- 사용자가 다른 앱에 있는 동안 **백그라운드에서 음악을 재생**하거나, **사용자 액티비티 간의 상호작용을 차단하지 않고 네트워크를 통해 데이터**를 가져올 수 있음(비동기 로직)

### 1.5.3 Broadcast Receiver

- 시스템이 정기적인 플로우 밖에서 이벤트를 앱에 전달하도록 지원하는 컴포넌트
- 대다수 브로드 캐스트는 시스템에서 발생(화면 꺼짐, 배터리 부족, 사진 캡쳐 알림 등) → PUSH
- 일반 앱도 브로드캐스트를 사용하여 UI를 표시하지만 상태 표시줄 알림을 생성
- 앱에서 알람이 발생하면 백그라운에서 동작을 하고 있다가 알람이 발생할 때 자바 앱이 일시적으로 동작하면서 push 알람을 사용자에게 보여준다.
- 내부적으로는 인텐트가 호출된다. 즉 인텐트가 Broadcast Receiver에게 push 알람을 처리하도록 호출을 한다.
- 인텐트 → Broadcast Receiver → 앱 순서대로 동작

### 1.5.4 콘텐츠 프로바이더

- 콘텐츠 제공자는 파일 시스템, SQLite 데이터 베이스, 웹상이나 앱이 접급할 수 있는 다른 모든 영구 저장소에 저장 가능한 앱 데이터 집합을 관리
- 다른 앱은 콘텐츠 제공자를 통해 해당 데이터를 쿼리하거나, 콘텐츠 제공자가 허용할 경우 수정도 가능
- 안드로이드 시스템은 사용자의 연락처 정보를 관리하는 콘텐츠 제공자를 제공하여, 적절한 권한을 가진 앱이라면 콘텐츠 제공자를 쿼리하여 특정한 인물에 대한 정보를 읽고 쓸 수 있음

안드로이드 manifest에서 4대 컴포넌트 정보를 확인할 수 있다.

## 1.6 안드로이드 루팅

- 샌드박스를 벗어나려면?
    - 각 앱마다 샌드박스 형태로 보호가 되어 있어서 다른 앱에서 특정 앱에 대한 권한을 가져갈 수 없다.
    - 따라서 루팅을 이용해야 샌드박스 안에 있는 앱의 접근 권한을 얻어 올 수 있다.
    - 리눅스 커널의 보안을 손상 → 변경, 루팅
- root 권한은 모든 작업을 수행할 수 있는 최고 사용자 수준
- 안드로이드/리눅스에서는 소수 핵심 유틸리만 root 권한으로 실행됨
- But, 장치를 Rooting하면 실행 중인 모든 앱에서 root 권한으로 사용 가능
- 녹스, 지니모션을 통해 루트 권한(#)을 얻을 수 있음 → 별도의 루팅 작업이 필요가 없다
- 루트 접근 권한을 얻어 디바이스를 완전히 제어 가능

## 1.7 안드로이드 루팅을 하는 이유

- 사용자마다 목표가 다름
- 테마 변경, 루트 권한 없이 설치할 수 없는 앱을 설치하기 위해
- 파일 시스템과 앱을 감시하기 위해

## 1.8 안드로이드 루팅 장점

- 장치에 대한 무제한 제어
    - 루트 접근 권한으로 파일 시스템 탐색 가능
        
        ```
        shell@android:/ $ls /data/data
        opendir failed, Permission denied
        ```
        
        ```
        shell@android:/ $su
        root@android:/ #ls /data/data 
        com.android.backupconfirm
        com.android.bluetooth
        ```
        
- 추가 앱 설치
    - 루트 접근 권한이 있는 사용자는 특별한 기능이 있는 일부 앱 설치 가능(예: BusyBox → 리눅스 명령어 도구)
- 더 많은 기능 및 사용자 정의

## 1.9 안드로이드 루팅 단점

- 디바이스 보안을 손상 시킴
    - 기본적으로 앱은 별도의 사용자 아이디가 할당된 자체 샌드박스 내에서 실행됨
    - 루팅된 디바이스에서 악성 앱이 설치가 되면 중요한 폴더가 노출될 수 있음
- 장치 벽돌
    - 디바이스를 손상시켜 쓸모 없게 될 수 있음
- 보증 무효화