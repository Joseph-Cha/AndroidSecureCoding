# 02. 안드로이드 앱 진단 환경 이해 및 설치

## JVM & DVM

### 자바 가상 머신(Java Virtual Machine, JVM)

- 자바 바이트 코드를 실행하기 위한 자바 가상 머신
- 자바 바이트 코드는 JVM이 이해할 수 있는 언어로 JVM만 설치되어 있으면 어떤 운영체제도 실행 가능

### 달빅 가상 머신(Dalvic Virtual Machine, DVM)

- 안드로이드 애플리케이션을 실행하기 위한 달빅 가상 머신
    - 컴파일 된 자바 소스(.class)를 안드로이드 환경에 맞춰 최적화를 하여(dex compiler) 달빅 바이트 코드(.dex)를 만들어서 달빅 가상 머신에서 동작하도록 한다.

## JVM

- 자바 바이트 코드(.class)를 실행하기 위한 자바 가상 머신
- JVM은 플랫폼에 의존적
- 자바 바이트 코드는 플랫폼에 독립적

## DVM

- 달빅 가상 머신
- 모바일 디바이스 환경에 최적화 되어 개발된 가상 머진으로 낮은 메모리에서 실행되도록 설계됨
    - 배터리 수명 문제 해결
    - 선능 문제
- 자바 바이트 코드로 변환되는 동일한 과정을 거친 후 추가적인 단계 진행
- DEX 컴파일러가 class 파일을 dex 파일로 변경하여 DVM에서 실행 가능하게 생성
    - .class 파일은 자바 바이트 코드
    - .java 파일은 자바 소스 코드

## JVM & DVM 비교

- 스택 기반 & 레지스터 기반
- Dalvik의 명령 수가 더 적고, 코드 길이는 더 길다(효율성과 속도).

![Untitled](/resources/2.1_JVM_vs_DVM.png)

자바는 stack 기반

달빅은 register 기반

## 스택 기반 & 레지스터 기반

### 스택 기반

- 연산할 때 스택 사용
- PUSH, POP 연산자 사용
- 20과 7의 ADD를 위한 명령어
    
    ```nasm
    POP 20
    POP 7
    ADD 20, 7 result
    PUSH result
    ```
    
    ![Untitled](/resources/2.2_%EC%8A%A4%ED%83%9D.png)
    

### 레지스터 기반(smali 코드)

- 연산할 때 레지스터 사용
- CPU 레지스터를 기반으로 피 연산자가 저장
- PUSH, POP 연산자가 없어 간단한 명령으로 진행 ⇒ 모바일은 빨라야 하므로
    
    ```nasm
    ADD R1, R2, R3
    ```
    
    ![Untitled](/resources/2.3_register.png)
    

## ART

- 안드로이드 런타임(Anroid Runtime, ART)
    - DVM은 옛날 방식이고 현재는 ART 방식으로 변경 되었다.
    - dex 파일은 동일
    - 다만 dex 파일이 안드로이드에서 DVM이 아니라 ART 방식으로 동작한다.
- 퍼포먼스 개선 등을 위해 구글이 DVM에서 ART로 변경
- 성능 향상을 위한 DVM의 “JIT 컴파일 프로세스를 “AOT 컴파일”로 변경
- 2016 안드로이드 누가(7.0) 이후 ART에서는 JIT와 AOT 컴파일 모두 사용

## JIT & AOT 컴파일 비교

- JIT(Just-In-Time) 컴파일
    - 앱 최초 실행 시에 컴파일을 수행하여(실행 시점에 컴파일), 하드웨어 부하로 배터리 시간 등 부정적인 영향을 미침
    - 장점: 용량 ↓, 설치 속도 ↑
    - 단점: 실행 속도 ↓, 배터리 사용 ↑, CPU 사용 ↑
- AOT(Ahead of time) 컴파일
    - 2014 안드로이드 롤리팝(5.0 API 21) 이후 ART(AOT)가 적용
    - 앱 설치 시점에서 컴파일을 수행하여, 전력 소비를 줄이면서 성능을 2배 향상 시킴
    - 장점: 실행 속도 ↑, 배터리 사용 ↓, CPU 사용 ↓
    - 단점: 용량 ↑, 설치 속도 ↓

## JIT & AOT 컴파일 비교

- JIT + AOT 컴파일
    - 2016 안드로이드 누가(7.0 API 24) 이후 ART에서는 JIT와 AOT 컴파일 모두 사용
    - JIT와 AOT를 모두 사용하여 설치시에는 무조건 JIT를 사용하고 차후 상황에 따라 유연하게 적용되어 사용됨

## JVM & DVM & ART 비교

![Untitled](/resources/2.4_JVM_DVM_ART.png)

어떤 컴파일 정책을 사용하냐는 분석하는 관점에서 크게 중요하지 않다.

왜나하면 앱에 관련된, 즉 앱이 실행되고 난 뒤 시점에서는 앱이 어떻게 컴파일이 되었든 어쨌든 앱이 동작하는 위쪽에 있는 기능들을 봐야하기 때문에 안에서 어떻게 컴파일이 되어 있는 지는 크게 중요하지 않다.